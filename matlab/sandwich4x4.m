function [z] = sandwich4x4(x, y)

% z = sandwich4x4(x, y)
% compute x*y*x' provided y = hermitian
% and dimensionatity is 4x4xN

%FIXME build in check for hermitianity
n     = size(x,1);
siz   = [size(y) 1];
z     = complex(zeros([n,n,siz(3:end)]));
xconj = conj(x);
xy    = mtimes4x4(x,y);

switch n
  case 1
    z(1,1,:,:) = xy(1,1,:,:).*xconj(1,1,:,:) + ...
      xy(1,2,:,:).*xconj(1,2,:,:) + ...
      xy(1,3,:,:).*xconj(1,3,:,:) + ...
      xy(1,4,:,:).*xconj(1,4,:,:);
  case 2
    z(1,1,:,:) = xy(1,1,:,:).*xconj(1,1,:,:) + ...
      xy(1,2,:,:).*xconj(1,2,:,:) + ...
      xy(1,3,:,:).*xconj(1,3,:,:) + ...
      xy(1,4,:,:).*xconj(1,4,:,:);
    
    z(2,1,:,:) = xy(2,1,:,:).*xconj(1,1,:,:) + ...
      xy(2,2,:,:).*xconj(1,2,:,:) + ...
      xy(2,3,:,:).*xconj(1,3,:,:) + ...
      xy(2,4,:,:).*xconj(1,4,:,:);
    
    z(2,2,:,:) = xy(2,1,:,:).*xconj(2,1,:,:) + ...
      xy(2,2,:,:).*xconj(2,2,:,:) + ...
      xy(2,3,:,:).*xconj(2,3,:,:) + ...
      xy(2,4,:,:).*xconj(2,4,:,:);
    
    z(1,2,:,:) = conj(z(2,1,:,:));
    
  case 4
    z(1,1,:,:) = xy(1,1,:,:).*xconj(1,1,:,:) + ...
      xy(1,2,:,:).*xconj(1,2,:,:) + ...
      xy(1,3,:,:).*xconj(1,3,:,:) + ...
      xy(1,4,:,:).*xconj(1,4,:,:);
    
    z(2,1,:,:) = xy(2,1,:,:).*xconj(1,1,:,:) + ...
      xy(2,2,:,:).*xconj(1,2,:,:) + ...
      xy(2,3,:,:).*xconj(1,3,:,:) + ...
      xy(2,4,:,:).*xconj(1,4,:,:);
    
    z(3,1,:,:) = xy(3,1,:,:).*xconj(1,1,:,:) + ...
      xy(3,2,:,:).*xconj(1,2,:,:) + ...
      xy(3,3,:,:).*xconj(1,3,:,:) + ...
      xy(3,4,:,:).*xconj(1,4,:,:);
    
    z(4,1,:,:) = xy(4,1,:,:).*xconj(1,1,:,:) + ...
      xy(4,2,:,:).*xconj(1,2,:,:) + ...
      xy(4,3,:,:).*xconj(1,3,:,:) + ...
      xy(4,4,:,:).*xconj(1,4,:,:);
    
    z(2,2,:,:) = xy(2,1,:,:).*xconj(2,1,:,:) + ...
      xy(2,2,:,:).*xconj(2,2,:,:) + ...
      xy(2,3,:,:).*xconj(2,3,:,:) + ...
      xy(2,4,:,:).*xconj(2,4,:,:);
    
    z(3,2,:,:) = xy(3,1,:,:).*xconj(2,1,:,:) + ...
      xy(3,2,:,:).*xconj(2,2,:,:) + ...
      xy(3,3,:,:).*xconj(2,3,:,:) + ...
      xy(3,4,:,:).*xconj(2,4,:,:);
    
    z(4,2,:,:) = xy(4,1,:,:).*xconj(2,1,:,:) + ...
      xy(4,2,:,:).*xconj(2,2,:,:) + ...
      xy(4,3,:,:).*xconj(2,3,:,:) + ...
      xy(4,4,:,:).*xconj(2,4,:,:);
    
    z(3,3,:,:) = xy(3,1,:,:).*xconj(3,1,:,:) + ...
      xy(3,2,:,:).*xconj(3,2,:,:) + ...
      xy(3,3,:,:).*xconj(3,3,:,:) + ...
      xy(3,4,:,:).*xconj(3,4,:,:);
    
    z(4,3,:,:) = xy(4,1,:,:).*xconj(3,1,:,:) + ...
      xy(4,2,:,:).*xconj(3,2,:,:) + ...
      xy(4,3,:,:).*xconj(3,3,:,:) + ...
      xy(4,4,:,:).*xconj(3,4,:,:);
    
    z(4,4,:,:) = xy(4,1,:,:).*xconj(4,1,:,:) + ...
      xy(4,2,:,:).*xconj(4,2,:,:) + ...
      xy(4,3,:,:).*xconj(4,3,:,:) + ...
      xy(4,4,:,:).*xconj(4,4,:,:);
    
    z(1,2,:,:) = conj(z(2,1,:,:));
    z(1,3,:,:) = conj(z(3,1,:,:));
    z(1,4,:,:) = conj(z(4,1,:,:));
    z(2,3,:,:) = conj(z(3,2,:,:));
    z(2,4,:,:) = conj(z(4,2,:,:));
    z(3,4,:,:) = conj(z(4,3,:,:));
  otherwise
    for k = 1:n
      for m = k:n
        z(k,m,:,:) = xy(k,m,:,:).*xconj(m,1,:,:) + ...
          xy(k,2,:,:).*xconj(m,2,:,:) + ...
          xy(k,3,:,:).*xconj(m,3,:,:) + ...
          xy(k,4,:,:).*xconj(m,4,:,:);
        z(m,k,:,:) = conj(z(k,m,:,:));
      end
    end
    
end

% b1  b2  b3  b4    a1 a2' a3' a4'   b5'
%                   a2 a5  a6' a7'   b6'
%                   a3 a6  a8  a9'   b7'
%                   a4 a7  a9  a10   b8'
%
% a1b1b5'+a2b2b5'+a3b3b5'+a4b4b5'+a2'b1b6'+a5b2b6'+a6b3b6'+a7b4b6'+a3'b1b7'+a6'b2b7'+a8b3b7'+a9b4b7'+a4'b1b8'+a7'b2b8'+a9'b3b8'+a10b4b8'

% a1b1^2+2Re(a2b2b1')+2Re(a3b3b1')+2Re(a4b4b1')+a5b2^2+2Re(a6b3b2')+2Re(a7b4b2')+a8b3^2+2Re(a9b4b3')+a10b4^2
